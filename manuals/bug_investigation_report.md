# テストプレイ用バグ調査レポート

## 1. スキル効果の処理に関する確認項目

### 1.1 CUSTOM_EFFECT（カスタム効果）関連

現在実装されているカスタム効果は以下の通りです：

| 効果名 | 実装ファイル | 使用スキル例 | 確認ポイント |
|--------|-------------|-------------|-------------|
| **破裂爆発** | `plugins/burst.py` | Pb-04「回転殴撃」<br>Pb-05「圧殺」<br>Pb-07「破砕」 | ・破裂値が正しくダメージに変換されるか<br>・破裂値の消費が正しく行われるか<br>・「破裂威力減少無効」バフがある場合、破裂値が維持されるか |
| **亀裂崩壊（ダメージ）** | `plugins/fissure.py` | Pb-07「破砕」 | ・亀裂値×倍率のダメージが正しく計算されるか<br>・亀裂値が0にリセットされるか |
| **亀裂崩壊（誘発）** | `plugins/fissure.py` | （パッシブスキル等で使用） | ・亀裂5毎に破裂爆発が誘発されるか<br>・連続誘発時の破裂値減少が正しく動作するか<br>・最大誘発回数の制限が機能するか |
| **出血氾濫** | `plugins/standard.py` | Ps-05「霹靂一閃」 | ・出血値と同じダメージが発生するか<br>・出血値は維持されるか（消費しない） |
| **戦慄殺到** | `plugins/standard.py` | E-11「心に従いましょう」 | ・戦慄値分のMPが減少するか<br>・MP0になった場合、混乱が付与されるか<br>・戦慄値が0にリセットされるか |
| **荊棘飛散** | `plugins/standard.py` | E-13「蔓延るがよい」 | ・対象の荊棘値が0になるか<br>・全キャラクター（対象以外）に荊棘が配布されるか<br>・死亡/未配置キャラが除外されるか |
| **スキルダメージ再適用** | `plugins/standard.py` | Ps-04「乱斬」（速度8以上の条件付き） | ・条件を満たした場合のみ追加ダメージが発生するか<br>・ダメージ量が元のスキルダメージと同じか |

#### 🔴 優先度高：確認すべきスキル

1. **Pb-05「圧殺」** - 破裂爆発を2回実行（1回目は破裂値を半分に）
   - 破裂値の減少率が正しいか（0.5倍）
   - 2回目の爆発が正しく実行されるか

2. **Pb-07「破砕」** - 破裂爆発と亀裂崩壊を同時実行
   - 両方の効果が正しく発動するか
   - ダメージ計算が正しいか

3. **E-11「心に従いましょう」** - 戦慄殺到（MP減少＋混乱付与）
   - MP減少の処理順序が正しいか
   - MP0時の混乱付与が確実に動作するか

4. **Ps-04「乱斬」** - 条件付き追加攻撃
   - 速度値のチェックが正しく動作するか
   - 追加ダメージ量が正しいか

### 1.2 条件付き効果（Condition）

多くのスキルが条件判定を使用しています。以下の条件タイプを重点的にテスト：

| 条件タイプ | 使用例 | 確認ポイント |
|-----------|--------|-------------|
| **パラメータ比較** | Pb-02「鳩尾殴り」（破裂≧8で追加効果） | ・境界値（7, 8, 9）で動作が変わるか |
| **タグ判定** | E-13「蔓延るがよい」（守備スキルなら基礎威力+3） | ・対象のスキルタグが正しく判定されるか |
| **スキルソース判定** | 各種power_bonusの条件 | ・「self」「target」「skill」の参照が正しいか |

#### 🟡 優先度中：確認すべきスキル

1. **Pb-02「鳩尾殴り」** - 破裂8以上で追加の破裂5付与
   - 破裂値7と8で動作が異なるか

2. **E-13「蔓延るがよい」** - 守備スキル使用時に基礎威力+3
   - 防御/回避スキルに対して正しく発動するか

### 1.3 状態異常の付与と計算

| 状態異常 | 付与制限 | 確認ポイント |
|---------|---------|-------------|
| **亀裂** | 1ラウンド1回まで | ・同じラウンド内で2回目の亀裂付与が失敗するか<br>・ラウンド終了時にフラグがリセットされるか |
| **出血/破裂/戦慄** | 制限なし | ・複数回の付与が正しく累積するか |
| **荊棘** | 制限なし | ・ラウンド終了時のダメージ処理が正しいか |

#### 🔴 優先度高：亀裂の1ラウンド1回制限

以下のスキルを連続使用してテスト：

- E-03「鋭い腕先」（亀裂1付与）
- E-08「仄かな光刃」（亀裂1付与）

**テスト手順：**

1. 同じラウンド内でE-03を使用 → 亀裂1付与される
2. 続けてE-08を使用 → 亀裂付与が失敗するはず
3. 次のラウンド開始
4. E-03を使用 → 再び亀裂1付与されるはず

### 1.4 威力ボーナス計算（power_bonus）

複雑な計算を含むスキル：

| スキル | 計算式 | 確認ポイント |
|--------|--------|-------------|
| **E-11「心に従いましょう」** | 戦慄5につき+1（最大2） | ・戦慄0,5,10,15での威力を確認 |
| **Pb-04「回転殴撃」** | 破裂3につき+1（最大3） | ・破裂0,3,6,9,12での威力を確認 |
| **E-14「死ね」** | 出血5につき+1（最大なし） | ・出血10,20,30での威力を確認 |

#### 🟡 優先度中：境界値テスト

各スキルで以下の値をテスト：

- 閾値の直前（例：戦慄4）
- 閾値ぴったり（例：戦慄5）
- 閾値の直後（例：戦慄6）

### 1.5 バフシステム

| バフタイプ | 実装箇所 | 確認ポイント |
|-----------|---------|-------------|
| **遅延バフ（delay）** | `game_logic.py:103-104` | ・delay > 0の間、バフ効果が無効化されるか<br>・delayが0になった時点で効果が発動するか |
| **持続バフ（lasting）** | `game_logic.py` | ・lasting回減少後に削除されるか |
| **消費型バフ** | `game_logic.py:316-319` | ・状態異常付与時にバフが消費されるか |
| **時限爆発バフ** | `plugins/buffs/time_bomb.py` | ・delay=0になった時に爆発するか |

#### 🔴 優先度高：遅延バフのテスト

**E-16「ちょっとした準備」** をテスト：

1. スキル使用
2. 次のラウンド（delay=1→0）で物理補正+2が適用されるか
3. さらに次のラウンドで物理補正-2が適用されるか

### 1.6 新機能：MULTIPLY_STATE（状態異常乗算）

実装状況：`game_logic.py:368-382`に実装済み

**確認ポイント：**

- 乗算後の値が正しく四捨五入されるか
  - 例：出血5 × 1.5 = 7.5 → 8（四捨五入）
  - 例：出血5 × 2.0 = 10（整数）

**テストケース：**

- 乗算値が整数になる場合
- 乗算値が小数（.5未満）になる場合
- 乗算値が小数（.5ちょうど、.5超）になる場合

## 2. 画面表示の確認項目

### 2.1 スキル計算結果の表示

| 項目 | 確認内容 |
|------|---------|
| **コマンド文字列** | ・基礎威力、ダイス、補正が正しく表示されるか<br>・戦慄によるダイス減少が反映されるか |
| **ダメージ範囲** | ・最小～最大ダメージが正しく計算されるか<br>・威力補正が反映されるか |
| **補正詳細** | ・基礎威力補正、物理/魔法補正、威力補正が個別に表示されるか |
| **コスト表示** | ・MP/FP消費が正しく表示されるか<br>・複数コストが全て表示されるか |

#### 🟡 優先度中：表示崩れの確認

以下の状況で表示を確認：

1. **長いスキル名** - 表示が途切れないか
2. **複数の補正** - 全ての補正が表示されるか（スクロール可能か）
3. **マッチパネル** - ステータスバーが名前の下に正しく表示されるか

### 2.2 Wide Match（広域戦）の表示

| 項目 | 確認内容 |
|------|---------|
| **ディフェンダーリスト** | ・全てのディフェンダーが表示されるか<br>・スクロールが必要ない程度に展開されるか |
| **スキル選択の保持** | ・他のキャラがスキル宣言しても、未宣言キャラの選択が維持されるか |
| **実行ボタン** | ・マッチ実行後、「実行中...」状態から正しくリセットされるか |
| **戦慄表示** | ・ディフェンダー側の戦慄によるダイス減少が表示されるか |

#### 🔴 優先度高：Wide Matchの同期

**テスト手順：**

1. Wide Matchで攻撃者Aがスキル選択（未宣言）
2. 防御者Bがスキル宣言
3. 攻撃者Aのスキル選択が維持されているか確認
4. 攻撃者Aが宣言
5. マッチ実行
6. 実行ボタンが「実行中...」から通常状態に戻るか確認

### 2.3 HP/MP/FPバーの表示

| 確認項目 | 予想される問題 |
|---------|---------------|
| **背景との視認性** | ダークモード等で文字が見づらくないか |
| **位置** | 名前の下に正しく配置されるか |
| **更新** | リアルタイムで値が更新されるか |

## 3. パフォーマンスと通信遅延の最適化

### 3.1 現在の通信パターン

| イベント | 発生頻度 | ペイロードサイズ |
|---------|---------|----------------|
| **full_state_update** | マッチ後、ラウンド後 | 大（全キャラクターの全ステータス） |
| **char_stat_updated** | 個別ステータス変更時 | 小（1キャラの1ステータスのみ） |
| **new_log** | ログ追加時 | 小（テキストのみ） |

#### 🟡 提案：差分更新の活用

`char_stat_updated`イベントが既に実装されているため、以下を確認：

1. HP/MP変更時に差分更新が使用されているか
2. フロントエンドで差分更新を受信しているか
3. 不要なfull_state_updateを削減できるか

### 3.2 サーバー側のボトルネック

| 処理 | 確認ポイント |
|------|-------------|
| **ログ出力** | ・verbose printが多用されていないか<br>・本番環境でログレベルが適切か |
| **状態同期** | ・不必要な全体同期が発生していないか |
| **マッチ解決** | ・複雑なスキル（多段効果）で処理時間が長くないか |

#### 🟢 提案：ロギングの最適化

現在、多数の`print`文が存在する可能性があります。以下を検討：

1. `logging`モジュールへの移行
2. 本番環境では`INFO`レベル以下に制限
3. デバッグログは`DEBUG`レベルに分類

### 3.3 ユーザビリティ向上策

| 施策 | 効果 |
|------|------|
| **ローディング表示** | ・マッチ実行中に「処理中」インジケーターを表示 |
| **楽観的UI更新** | ・クライアント側で先行表示し、サーバー結果で補正 |
| **キャッシング** | ・スキルデータ等の静的情報をクライアント側でキャッシュ |

## 4. テスト優先順位まとめ

### 🔴 最優先（手動テストで必ず確認）

1. **亀裂の1ラウンド1回制限** - ゲームバランスに直結
2. **破裂爆発の連続実行** (Pb-05) - 複雑なロジック
3. **破裂爆発＋亀裂崩壊の複合** (Pb-07) - 複雑なロジック
4. **遅延バフの動作** (E-16) - タイミングが重要
5. **Wide Matchの同期** - マルチプレイの要

### 🟡 中優先（時間があれば確認）

1. **条件付き威力ボーナスの境界値**
2. **戦慄によるダイス減少表示**
3. **コスト表示の完全性**
4. **長いスキル名の表示崩れ**

### 🟢 低優先（必要に応じて確認）

1. **各種エフェクトの視覚的表現**
2. **ログの詳細度**
3. **パフォーマンス計測**

## 5. バグ発見時の記録テンプレート

バグを発見した場合、以下の情報を記録してください：

```
【スキル名/機能】:
【再現手順】:
1.
2.
3.

【期待される動作】:

【実際の動作】:

【関連するステータス値】:
- HP/MP/FP:
- 状態異常:
- バフ:

【エラーメッセージ】（あれば）:

【スクリーンショット】（可能なら）:
```

---

## 補足：実装されている効果タイプ一覧

`game_logic.py`で処理可能な全効果タイプ：

1. **APPLY_STATE** - 状態異常付与（HP, MP, FP, 出血, 破裂, 亀裂, 戦慄, 荊棘等）
2. **APPLY_BUFF** - バフ付与
3. **REMOVE_BUFF** - バフ解除
4. **DAMAGE_BONUS** - 追加ダメージ
5. **MODIFY_ROLL** - ロール修正
6. **CUSTOM_EFFECT** - カスタム効果（プラグインで実装）
7. **FORCE_UNOPPOSED** - 一方攻撃強制
8. **MODIFY_BASE_POWER** - 基礎威力変更
9. **MULTIPLY_STATE** - 状態異常値の乗算
10. **APPLY_STATE_PER_N** - パラメータに基づく動的付与

各タイミング：

- `PRE_MATCH` - マッチ前
- `HIT` - 的中時
- `WIN` - マッチ勝利時
- `LOSE` - マッチ敗北時
- `UNOPPOSED` - 一方攻撃時
- `END_MATCH` - マッチ終了時
- `END_ROUND` - ラウンド終了時
