# パフォーマンスと通信遅延の最適化計画書

## 1. 概要

本ドキュメントは、Gem DiceBot Toolにおけるパフォーマンス上の課題、特に通信遅延とサーバー負荷を軽減するための最適化計画をまとめたものである。現状のコードベース分析に基づき、段階的な改善策を提案する。

## 2. 現状分析

### 2.1 実装済みの基盤機能 ✅

以下の機能は既にコードベースに存在するが、活用が不十分な状態である。

- **ロギングシステム** (`manager/logs.py`)
  - `logging`モジュールベースの実装。RENDER環境（本番）ではINFOレベル、開発環境ではDEBUGレベルに自動切り替え可能。
- **差分更新イベント** (`char_stat_updated`)
  - サーバー側: `manager/room_manager.py` で定義済み。
  - クライアント側: `SocketClient.js` で受信ハンドラ定義済み。
- **Gunicorn/Eventlet設定**
  - 非同期ワーカー設定、プロセス管理設定は適用済み。

### 2.2 課題とボトルネック ❌

1. **過剰なログ出力 (I/O負荷)**
    - コード全体で320箇所以上の `print()` 文が残存している。
    - 本番環境でもこれらが出力され、I/O負荷とログの見づらさを招いている。

2. **非効率なデータ通信 (帯域負荷)**
    - マッチ結果処理や複数対象へのスキル適用時に、部屋全体の全データを再送信する `state_updated` (full update) が多用されている。
    - 差分更新 (`char_stat_updated`) が単一ステータス変更時 (`_update_char_stat`) 以外で活用されていない。

3. **クライアント描写の遅延**
    - 差分更新イベントを受け取っても、クライアント側でDOMを直接更新する処理が実装されていない（EventBusへの通知のみ）。
    - 結果として、結局フル更新を待つことになり、ユーザー体験上のレスポンスが悪い。

4. **UX上の体感速度**
    - 処理中（計算中、通信中）を示すローディング表示が不足しており、ユーザーがフリーズと勘違いしやすい。

---

## 3. 改善フェーズ計画

### Phase 1: ロギング最適化（即時着手推奨）🔴

**目的:** I/O負荷の削減とログ可読性の向上
**リスク:** 低

1. **print文の撤廃とLoggerへの移行**
    - `manager/game_logic.py`, `duel_solver.py`, `wide_solver.py` などの主要モジュール内の `print()` を `logger.debug()` / `logger.info()` に置換。
2. **ログレベルの適切な設定**
    - 開発時のみ必要な情報は `DEBUG`。
    - 運用上重要なイベント（部屋作成、マッチ終了など）は `INFO`。
    - エラーは `ERROR`。

### Phase 2: 通信の差分更新化（中期的実施）🟡

**目的:** 通信ペイロードの削減とサーバー負荷軽減
**リスク:** 中（状態不整合のリスクがあるため慎重に実装要）

1. **バトル処理の差分更新化**
    - マッチ終了時、全データを送るのではなく、影響を受けたキャラクター（HP/MP変動、状態異常付与があったキャラ）のみの差分データを作成し送信する処理を追加。
2. **クライアント側DOM部分更新**
    - `char_stat_updated` イベント受信時に、React/Vue等の再レンダリングを待たず、直接DOM（HPバーの幅など）を操作して即座に画面に反映させるロジックを実装。

### Phase 3: データキャッシュと永続化（長期的実施）🟢

**目的:** 起動時間の短縮とAPIリクエスト削減
**リスク:** 低

1. **静的データのキャッシュ**
    - スキルデータ、アイテムデータなどの頻繁に変更されないマスターデータを、クライアント側（localStorage/IndexedDBあるいはメモリ変数）にキャッシュし、毎回APIを叩かないようにする。

### Phase 4: UX最適化 🟡

**目的:** 体感速度の向上

1. **ローディングインジケーターの実装**
    - マッチ実行ボタン押下時からサーバー応答があるまでの間、画面にスピナーや「処理中」ステータスを明示する。
2. **楽観的UI更新（Optimistic Updates）**
    - MP消費などをサーバー応答を待たずに先行して減算表示し、エラー時のみロールバックする実装（難易度高のため後回し可）。

---

## 4. 検証方法

### ロギング検証

- 環境変数 `RENDER=true` を設定してサーバーを起動し、コンソールにデバッグログが出力されないことを確認する。

### 通信検証

- ブラウザの開発者ツール（Networkタブ/WS）で、マッチ実行時の通信フレームを確認。
- 巨大なJSONオブジェクト（`state_updated`）の頻度が減り、小さなパケット（`char_stat_updated`）が増えていることを確認する。

### パフォーマンス検証

- 多数のキャラクターがいる部屋での広域戦実行時のラグを体感および計測で比較する。
