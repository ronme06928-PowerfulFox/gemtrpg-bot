# 探索モード (Exploration Mode) マニュアル

本ドキュメントでは、ジェムリアTRPGダイスボットに追加された「探索モード」の機能と操作方法について解説します。

## 1. 概要

探索モードは、グリッド（マス目）にとらわれない自由なキャラクター配置と、臨場感ある背景表示を重視したモードです。
戦闘シーン以外のロールプレイ（RP）パートや、ダンジョン探索、街中での会話シーンなどに適しています。

### 戦闘モードとの違い

- **自由移動**: マス目にスナップせず、ピクセル単位で好きな位置に配置可能です。
- **全画面表示**: チャットログなどのUIはそのままに、マップ領域全体を使って背景と立ち絵を表示します。
- **視点操作**: ズームイン・アウトやドラッグによる視点移動が可能です。

---

## 2. モードの切り替え (GMのみ)

画面左側の「アクションドック」（縦並びのアイコンメニュー）からモードを切り替えます。

1. **戦闘モード → 探索モード**
   - GM権限を持つユーザーのアクションドック最下部に追加される「🗺️（マップアイコン）」ボタンをクリックします。
   - 確認ダイアログで「OK」を選択すると、全員の画面が探索モードに切り替わります。

2. **探索モード → 戦闘モード**
   - 探索モード時は、アクションドックに「⚔️（剣アイコン）」ボタンが表示されます。
   - これをクリックすると、戦闘モード（グリッドマップ）に戻ります。

---

## 3. 基本操作

### 視点操作 (全ユーザー)

- **パン（視点移動）**:
  - 背景の何もない部分をドラッグすることで、視点を上下左右に移動できます。
- **ズーム（拡大縮小）**:
  - マウスホイールを回すか、画面右下の「＋」「－」ボタンで拡大縮小が可能です。
- **リセット**:
  - 画面右下の「リセット（回転矢印）」ボタンを押すと、初期視点（パン0, 倍率1.0）に戻ります。

### キャラクター情報の確認

- **詳細表示**:
  - キャラクターの立ち絵を**ダブルクリック**すると、キャラシート（ステータス詳細）が開きます。

---

## 4. GM用操作 (管理機能)

### キャラクターの配置

1. アクションドックの「📦（未配置ボックス）」アイコンをクリックします。
2. 未配置キャラクターの一覧が表示されます。
3. **「配置」ボタン**をクリックすると、**現在見ている画面の中央**にキャラクターが出現します。
   - ※以前は(0,0)座標などに配置されていましたが、現在は「迷子にならないよう、目の前に出現する」仕様になっています。

### キャラクターの移動

- キャラクターの立ち絵をドラッグ＆ドロップすることで、好きな位置に移動できます。
- この移動はリアルタイムで全員の画面に同期されます。

### 背景の変更

1. 画面右下の「🖼️（画像アイコン）」ボタン（または背景変更ボタン）をクリックします。
2. 画像ピッカーが開くので、使用したい画像を選択（またはアップロード）します。
3. 背景画像が即座に切り替わります。
   - 画像はウィンドウサイズに合わせて、全体が表示されるように自動調整されます（`contain`設定）。

### キャラクター画像の変更

- キャラクター詳細画面（ダブルクリックで表示）から画像を編集・保存すると、探索画面上の立ち絵も即座に新しい画像に更新されます。
- 画像が設定されていないキャラクターは、簡易的な「No Image」プレートとして表示されます。

---

## 5. 仕様・トラブルシューティング

- **キャラが見当たらない場合**:
  - 「未配置」から再度「配置」を行うか、一度戦闘モードに戻ってから再度探索モードに入り直してみてください。
  - 新しく配置されたキャラは、必ず「操作している人の画面中央」に出現します。

- **画像の表示サイズ**:
  - キャラクターの基本サイズは、通常のトークンより少し小さめ（幅200px程度）に調整されています。
  - 大きく見せたい場合は、ブラウザのズーム機能や探索画面のズーム機能をご利用ください。

- **レイヤー順序**:
  - キャラクターは常に背景画像の上に表示されます。キャラ同士が重なった場合、ドラッグ中のキャラが最前面に来ます。

---

## 付録: 戦闘画面（旧仕様）の描画仕様メモ

2026年1月時点での戦闘画面（Battle Mode）の描画ロジックについての覚書です。改修時のリファレンスとして使用します。

### 1. 座標系 (Coordinate System)

- **グリッド吸着**: マップは `GRID_SIZE = 90px` の正方形グリッドで構成されています。
- **座標データ**: サーバー上では `x`, `y` は整数値（`int`）として保存されます（例: `x=5, y=3`）。
- **ピクセル変換式**:

  ```js
  pixelX = char.x * GRID_SIZE + TOKEN_OFFSET; // TOKEN_OFFSETは微調整用
  pixelY = char.y * GRID_SIZE + TOKEN_OFFSET;
  ```

- **配置ロジック**: ドラッグ＆ドロップ時、マウス位置を `GRID_SIZE` で割り、`Math.floor` で整数化して送信します。

### 2. キャラクター駒のデザイン (Token Design)

- **形状**: 正方形 (82px x 82px)。
- **構成要素**:
  - **背景**: キャラクター画像が設定されている場合、`background-image` として表示。画像がない場合、頭文字のみ表示。
  - **枠線**: 味方（青）、敵（赤）、NPC（灰）の色分けボーダー。
  - **ステータスバー**: 駒の内部下側に、HP（緑）、MP（青）、FP（オレンジ）の3本の水平バーが配置されています。数値表示はありません（ツールチップでのみ表示）。
  - **状態異常アイコン**: 駒の周囲ではなく、駒内部の下部に小さなアイコン列として表示されます。

### 3. 移動・操作 (Interaction)

- **ドラッグ操作**: `draggable="true"` 属性を使用し、標準のHTML5 Drag & Drop APIを利用。
- **ターゲット**: ターゲット選択モード時、駒をクリックすることでIDを取得。

### 4. 背景画像 (Background)

- 特定の画像設定ロジックはなく、CSSで定義されたグリッドパターン（`background-image: linear-gradient(...)`）が表示されます。
