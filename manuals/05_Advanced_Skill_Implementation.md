# 05. 高度なスキル実装と特殊効果マニュアル

本ドキュメントでは、Gem DiceBot Tool に実装されている高度なスキル効果、動的バフ、および特殊なプラグイン仕様について解説します。

---

## 1. 動的バフ命名規則 (Dynamic Buff Patterns)

バフシステムには、バフの**名称**によって自動的に効果が適用される「動的パターン」が実装されています。
これらを使用することで、複雑なJSON定義を書かずに、名前だけでステータス補正や特殊効果を持つバフを作成できます。

| パターン (正規表現) | 効果説明 | 例 |
| :--- | :--- | :--- |
| `(.*)_Atk(\d+)` | 攻撃威力 +数値 | `激怒_Atk3` (攻撃威力+3) |
| `(.*)_Def(\d+)` | 守備威力 +数値 | `堅守_Def3` (守備威力+3) |
| `(.*)_AtkDown(\d+)` | 攻撃威力 -数値 | `脱力_AtkDown2` (攻撃威力-2) |
| `(.*)_DefDown(\d+)` | 守備威力 -数値 | `崩し_DefDown2` (守備威力-2) |
| `(.*)_Phys(\d+)` | 物理補正 +数値 | `剛力_Phys2` (物理補正+2) |
| `(.*)_PhysDown(\d+)` | 物理補正 -数値 | `軟化_PhysDown2` (物理補正-2) |
| `(.*)_Mag(\d+)` | 魔法補正 +数値 | `魔力_Mag3` (魔法補正+3) |
| `(.*)_MagDown(\d+)` | 魔法補正 -数値 | `封魔_MagDown3` (魔法補正-3) |
| `(.*)_DaIn(\d+)` | 被ダメージ倍率 (数値%) 増加 | `脆弱_DaIn20` (被ダメ1.2倍) |
| `(.*)_DaCut(\d+)` | 被ダメージ倍率 (数値%) 軽減 | `防壁_DaCut20` (被ダメ0.8倍 / 20%カット) |
| `(.*)_BleedReact(\d+)` | 被弾時に**自分**の出血 +数値 | `呪い_BleedReact2` (被弾する度、自分に出血+2) |
| `(.*)_Crack(\d+)` | 亀裂付与量 +数値 (永続/減らない) | `達人_Crack1` (常に亀裂付与+1) |
| `(.*)_CrackOnce(\d+)` | 亀裂付与量 +数値 (1回使い切り) | `次撃_CrackOnce2` (次の1回だけ亀裂付与+2) |

**使用方法:**
スキルの `effects` で `APPLY_BUFF` を使用し、`buff_name` に上記の規則に従った名前を指定してください。

```json
{
  "timing": "HIT",
  "type": "APPLY_BUFF",
  "buff_name": "脆弱_DaIn20", // 自動的に被ダメージ+20%の効果になる
  "lasting": 3
}
```

---

## 2. 高度なスキルロジック (Advanced Logic)

JSON設定により利用可能な、特殊な計算やターゲット処理です。

### 2-1. 定数比例付与 (Apply State Per N)

「自分の【ステータスA】Xにつき、【ステータスB】をY与える」といった効果を実現します。

* `type`: `"APPLY_STATE_PER_N"`
* `source`: 参照元 (`"self"`: 自分, `"target"`: 相手)
* `source_param`: 参照するステータス名 (例: `"戦慄"`, `"出血"`)
* `per_N`: 基準値 N
* `value`: 付与値 Y
* `max_value`: 付与上限 (任意)

**例: 自分の戦慄2につき、相手に亀裂1を付与 (最大5)**

```json
{
  "timing": "HIT",
  "type": "APPLY_STATE_PER_N",
  "target": "target",
  "state_name": "亀裂",
  "source": "self",
  "source_param": "戦慄",
  "per_N": 2,
  "value": 1,
  "max_value": 5
}
```

### 2-2. ランダムターゲット選定 (Random Target)

戦場にいるキャラクターの中から、条件に従ってランダムに対象を選出します。
広域攻撃や、ランダムな敵へのデバフ撒きなどに使用します。

* `target_select`: `"RANDOM"` (必須)
* `target_filter`: 陣営フィルタ (`"ENEMY"`, `"ALLY"`, `"ALL"`)
* `target_count`: 人数 (デフォルト 1)
* `include_self`: 自分を含めるか (`true`/`false`) ※ALLY/ALL時のみ有効

**例: ランダムな敵2体に「出血3」を付与**

```json
{
  "timing": "HIT",
  "type": "APPLY_STATE",
  "target_select": "RANDOM",
  "target_filter": "ENEMY",
  "target_count": 2,
  "state_name": "出血",
  "value": 3
}
```

### 2-3. フレーバーテキスト (Flavor Text)

バフ付与などのログに、演出用のメッセージを追加できます。

```json
{
  "timing": "HIT",
  "type": "APPLY_BUFF",
  "buff_name": "勇気の印",
  "flavor": "「負ける気がしない！」心に勇気が湧いてくる。"
}
```

---

## 3. 特殊バフプラグイン (Special Buff Plugins)

特定の `buff_id` を指定することで発動する、スクリプト制御された高度な特殊効果です。

### 3-1. 破裂威力減少無効 (Burst Conservation)

* **ID**: `Bu-06`
* **効果**: このバフを持つキャラクターが【破裂爆発】を受ける際、本来消費される【破裂】の値が減少しなくなります。
* **用途**: 「次の一撃だけ破裂を消費したくない（破裂2倍ダメージ用）」などのコンボに使用します。

### 3-2. 時限式破裂爆発 (Timed Burst)

* **ID**: `Bu-07`
* **効果**: バフの `delay` カウントが0になった瞬間、自分自身に対して【破裂爆発】が発動します。
* **動作**: 蓄積されている【破裂】値を参照してダメージを与えます。

### 3-3. 亀裂崩壊連鎖 (Dual Collapse / Burst Chain)

* **概要**: 「亀裂崩壊」発生時に、さらに別の効果（破裂爆発など）を誘発させることができます。
* **実装方法**: `fissure.py` プラグインの設定により、亀裂消費時に `triggered_effect` を指定して連鎖させることが可能です。（※要上級者向け設定）

### 3-4. 出血維持 (Bleed Maintenance)

* **ID**: `Bu-08`
* **効果**: このバフを持つキャラクターは、ラウンド終了時に【出血】の値が半減しません（現在の値を維持します）。
* **用途**: 出血特化のビルドや、長期的なDoT（継続ダメージ）戦略に使用します。

---

## 4. その他

### 状態異常の乗算 (Multiply State)

既存の状態異常値を倍加させる効果です。

* `type`: `"MULTIPLY_STATE"`
* `state_name`: 対象ステータス
* `value`: 乗数 (例: `2.0` で2倍, `0.5` で半減)

**例: 相手の「出血」を2倍にする**

```json
{
  "timing": "HIT",
  "type": "MULTIPLY_STATE",
  "target": "target",
  "state_name": "出血",
  "value": 2.0
}
```
