# システムパフォーマンス最適化 実装報告書

**更新日**: 2026/01/29
**バージョン**: 1.0

## 1. 概要

本ドキュメントは、Gem DiceBot Toolにおいて実施された、パフォーマンスチューニングおよびRender環境（本番環境）における通信遅延対策の実装内容をまとめたものである。これらは主に、**データベースI/Oの削減**、**通信ペイロードの最小化**、**ブラウザ描画負荷の軽減**を目的としている。

## 2. 実装された最適化策

### 2.1 Backend 最適化 (Python/Flask)

#### 1. DB保存頻度の抑制 (Batch Saving)

* **課題**: 以前は、戦闘ログを1行出力したり、キャラステータスを1つ変更するたびに、データベースへのフル保存（部屋データ全体の書き込み）が発生していた。これが「攻撃→防御→ダメージ適用→ログ出力」という一連の流れで数十回繰り返され、深刻な遅延の原因となっていた。
* **対策**:
  * `broadcast_log` および `_update_char_stat` 関数に `save` 引数を追加。
  * 戦闘解決ロジック (`duel_solver.py`, `wide_solver.py`) 内では、中間処理の間 `save=False` を指定し、オンメモリでのデータ更新にとどめる。
  * 処理がすべて完了した時点で、`save_specific_room_state` を呼び出し、一度だけDBに保存する。
* **効果**: 1回の戦闘アクションあたりのDB書き込み回数が **95%以上削減** され、処理速度が大幅に向上。

#### 2. 通信ペイロードの削減 (Differential Updates)

* **課題**: 広域マッチ（多数対多数）の宣言フェーズにおいて、参加者が1人宣言ボタンを押すたびに、部屋全体のデータを含む `state_updated` イベントが全員に送信されていた。人数が増えるとそのデータ量は無視できず、操作のたびにフリーズが発生していた。
* **対策**:
  * `wide_solver.py` から `broadcast_state_update` (全データ送信) の呼び出しを削除あるいはコメントアウト。
  * 代わりに軽量なイベント `wide_defender_updated` / `wide_attacker_updated` を発行。これには「誰が」「どのコマンドで」宣言したかという最小限の差分データのみを含める。
* **効果**: 宣言時の通信量が数KB〜数十KBから、**数百バイト程度** に削減され、マルチプレイ時の応答性が改善。

#### 3. 圧縮転送の導入 (Gzip Compression)

* **課題**: 本アプリケーションが扱うデータ（JSON）はテキスト形式であり、同じプロパティ名が頻出するため圧縮効率が非常に高いが、これまでは非圧縮で転送されていた。
* **対策**:
  * `Flask-Compress` ライブラリを導入 (`app.py`で初期化)。
  * サーバーからのレスポンス（特に初回ロード時の重いデータや、Socket.IOのポーリングフォールバック時）をGzip圧縮して送信。
* **効果**: テキストデータの転送サイズが **約1/10** に圧縮され、低帯域環境やモバイル環境でのロード時間が短縮。

---

### 2.2 Frontend 最適化 (JavaScript)

#### 1. 描画コストの削減 (Rendering Optimization)

* **課題**: サーバーから `state_updated` イベントが届くたびに、データの内容に変更がなくてもDOM（マッチパネル等）を再構築・再描画していた。
* **対策**:
  * `tab_visual_battle.js` の `renderMatchPanelFromState` 関数に、前回のマッチデータのJSONハッシュ（文字列化データ）をキャッシュする仕組みを導入。
  * 新しいデータが前回と完全に一致する場合、処理を早期リターンして再描画をスキップ。

#### 2. ログDOMの肥大化防止 (Log DOM Virtualization/Limiting)

* **課題**: 戦闘ログが無限に`<div>`として追加され続け、長時間プレイするとDOM要素数が数千〜数万に達し、ブラウザの動作が重くなっていた。
* **対策**:
  * 画面上に表示するログの上限を **200件** に設定。これを超えた古いログはDOMから削除される。
  * 過去の全ログを確認したい場合のために、「全ログを表示 (History)」ボタンとモーダル画面を実装。

#### 3. 広域マッチの差分描画 (Client-side Differential Rendering)

* **課題**: Backendで差分更新イベントを導入したことに伴い、Frontendでもそれを受け取って適切に処理する必要があった。
* **対策**:
  * `wide_match_synced.js` に `wide_defender_updated` / `wide_attacker_updated` のリスナーを追加。
  * これを受け取った際、リロードを待たずに即座に自身のローカルステート (`battleState`) を更新し、UI（ボタンの無効化、緑枠の付与、コマンド内容の表示）を更新する処理を実装。
  * Socket初期化タイミングの問題を解決するため、リスナー登録関数 `initWideMatchSocketListeners` を `tab_visual_battle.js` から確実に呼び出す構成に変更。

---

## 3. 関連ファイル一覧

| カテゴリ | ファイルパス | 主な変更点 |
| :--- | :--- | :--- |
| **Backend** | `app.py` | `Flask-Compress` 初期化追加 |
| | `requirements.txt` | `Flask-Compress` 追加 |
| | `manager/room_manager.py` | `broadcast_log` に `save` 引数追加 |
| | `manager/battle/duel_solver.py` | バッチ保存対応、不要なブロードキャスト抑制 |
| | `manager/battle/wide_solver.py` | バッチ保存対応、差分更新イベント実装 |
| **Frontend** | `static/js/tab_battlefield.js` | ログ表示数制限、履歴モーダル実装 |
| | `static/js/tab_visual_battle.js` | レンダリングキャッシュ、ログ制限、Socketリスナー初期化順序修正 |
| | `static/js/wide_match_synced.js` | 差分更新イベント受信、UI部分更新ロジック |

## 4. 今後の展望・残課題

* **詳細なパフォーマンス計測**: 改修後の数値を実際に計測し、さらなるボトルネックがあれば特定する（例: スキルデータのロード時間など）。
* **ログレベルの厳密な運用**: 開発用 (`print`) と本番用 (`logging`) が混在している箇所の整理（Phase 1計画の一部）。
