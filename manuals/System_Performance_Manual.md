# システムパフォーマンス最適化 実装報告書

**更新日**: 2026/02/02
**バージョン**: 1.1

## 1. 概要

本ドキュメントは、Gem DiceBot Toolにおいて実施された、パフォーマンスチューニングおよびRender環境（本番環境）における通信遅延対策の実装内容をまとめたものである。これらは主に、**データベースI/Oの削減**、**通信ペイロードの最小化**、**ブラウザ描画負荷の軽減**を目的としている。

## 2. 実装された最適化策

### 2.1 Backend 最適化 (Python/Flask)

#### 1. DB保存頻度の抑制 (Batch Saving)

* **効果**: 1回の戦闘アクションあたりのDB書き込み回数が **95%以上削減** され、処理速度が大幅に向上。

#### 2. 通信ペイロードの削減 (Differential Updates) - **v1.1 Update**

* **課題**: 広域マッチ宣言時や、キャラクター移動時に「部屋全体のデータ（数KB〜）」を送信していたため、連打や高速操作時に通信遅延と再描画ラグ（巻き戻り）が発生していた。
* **対策**:
  * **広域マッチ**: 宣言時に軽量な `wide_defender_updated` イベントのみを発行。
  * **キャラクター移動**: 通常の移動時には軽量な **`character_moved`** イベントのみを発行（座標とタイムスタンプのみ）。
  * **例外処理**: トークンの生成が必要な「未配置からの配置」や、削除が必要な「盤外への撤退（Dropout）」の場合のみ、従来のフルステート更新 (`broadcast_state_update`) を使用して整合性を保つ。
* **効果**: 移動時の通信量が **数百バイト程度** に削減され、高速操作時のラグが劇的に改善。

#### 3. 圧縮転送の導入 (Gzip Compression)

* **効果**: テキストデータの転送サイズが **約1/10** に圧縮。

#### 4. 静的ファイル配信の高速化 (WhiteNoise)

* **効果**: 静的リソースのロード時間が短縮。

---

### 2.2 Frontend 最適化 (JavaScript)

#### 1. 描画コストの削減 (Rendering Optimization)

* **課題**: サーバーから `state_updated` イベントが届くたびに、データの内容に変更がなくてもDOM（マッチパネル等）を再構築・再描画していた。
* **対策**:
  * `tab_visual_battle.js` 等で前回のデータのハッシュと比較し、変更がなければ再描画をスキップ。
  * **移動の差分更新**: `character_moved` イベント受信時は、React的な全再描画を行わず、対象トークンの `style.left/top` を直接書き換えることで描画負荷をほぼゼロにした。

#### 2. ログDOMの肥大化防止 (Log DOM Virtualization/Limiting)

* ログ表示数を最新200件に制限。

#### 3. Local Overrideによる体感速度向上 (Optimistic UI)

* 通信ラグによる「巻き戻り」を防ぐため、移動操作時はローカルの座標を即時反映し、サーバーからの古いTime Stampを持つ更新を無視するロジック(`ServerTS <= LocalTS`)を実装。

---

## 3. 関連ファイル一覧

| カテゴリ | ファイルパス | 主な変更点 |
| :--- | :--- | :--- |
| **Backend** | `events/socket_char.py` | `character_moved` イベント実装、ConfigによるFull/Diff切り替え |
| **Frontend** | `static/js/tab_visual_battle.js` | `character_moved` 受信・直接DOM更新、Local Overrideロジック |
