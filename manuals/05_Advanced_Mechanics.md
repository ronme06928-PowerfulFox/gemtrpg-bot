# 05. 高度なメカニクス (Advanced Mechanics)

このマニュアルでは、死亡時イベント、HPコスト、高度なターゲット指定、および条件付き効果の実装方法について解説します。

## 1. 死亡時イベント (Death Events)

キャラクターのHPが0になった瞬間に発動する効果を定義します。
バフまたはパッシブスキルとして定義し、`on_death` プロパティに効果配列を記述します。

### 定義例

```json
{
  "name": "呪いの遺言",
  "type": "PASSIVE",
  "on_death": [
    {
      "type": "APPLY_STATE",
      "target": "ALL_ENEMIES",
      "state_name": "呪い",
      "value": 3,
      "flavor": "「……末代まで呪ってやる……」"
    }
  ]
}
```

* **target**: 通常のスキル同様 `ALL_ENEMIES`, `RANDOM`, `target` (倒した相手) などが指定可能です。
* **注意**: この処理は「戦闘不能」状態に移行する直前に割り込んで実行されます。

---

## 2. HPコスト (HP Costs)

スキルのコストとしてMPやTPだけでなく、HPを消費させることが可能です。
`特記処理` (JSONデータ) 内の `cost` 配列で `type: "HP"` を指定します。

### 定義例

```json
"特記処理": {
  "cost": [
    {
      "type": "HP",
      "value": 5
    },
    {
      "type": "MP",
      "value": 2
    }
  ]
}
```

* **仕様**: 現在HPがコスト未満の場合、そのスキルは使用できません（コスト不足）。

---

## 3. 次の手番の味方選択 (Next Ally Targeting)

行動順（タイムライン）において、**自分の次に行動する味方**を対象とするスキルです。
バフの受け渡しや、連携攻撃の起点として使用できます。

### 定義例

```json
"特記処理": {
  "effects": [
    {
      "type": "APPLY_BUFF",
      "target": "NEXT_ALLY",
      "buff_id": "Bu-Example",
      "value": 1
    }
  ]
}
```

* **仕様**:
  * タイムライン上で自分の位置より後ろを検索し、最初に見つかった同陣営（PCならPC、敵なら敵）を対象とします。
  * タイムラインの末尾まで見つからなかった場合、先頭に戻って自分自身の手前まで検索します（自分は対象外）。
  * 生存している（HP>0）キャラクターのみが対象となります。

---

## 4. 条件付き効果 (Conditional Effects)

特定のスレッシュホールド（閾値）や状態異常の有無に応じて、効果を発動するかどうかを判定します。
すべての効果タイプ（`APPLY_STATE`, `APPLY_BUFF`, `DAMAGE_BONUS` 等）に対し、`condition` プロパティを追加することで制御できます。

### 定義例: 「出血」している相手に追加FP

```json
{
  "type": "APPLY_STATE",
  "state_name": "FP",
  "value": 1,
  "target": "self",
  "condition": {
    "source": "target",
    "param": "出血",
    "operator": "GTE",
    "value": 1
  }
}
```

### パラメータ詳細

* **source**: `self` (自分), `target` (相手)
* **param**: 参照するステータス名（`HP`, `MP`, `戦慄`, `出血` など）
* **operator**:
  * `GTE`: 以上 (>=)
  * `LTE`: 以下 (<=)
  * `GT`: より大きい (>)
  * `LT`: より小さい (<)
  * `EQUALS`: 等しい (==)
  * `CONTAINS`: (タグなどが)含まれる
* **value**: 比較する値

---

## 5. カウンター・スタックシステム

特定の「スタック（蓄積値）」をリソースとして消費・参照するメカニクスです。
独自のステータス（State）を定義し、それを参照・操作することで実現します。

### 実装パターン

1. **スタックの付与**: `APPLY_STATE` で独自のステータス名を指定（例: `"魔力"`, `"チャージ"`）。
2. **スタックによる強化**: `power_bonus` や `APPLY_STATE_PER_N` でそのステータスを参照。

### 定義例: 「魔力」スタックに応じて攻撃力アップ

```json
"特記処理": {
  "power_bonus": [
    {
      "source": "self",
      "param": "魔力",
      "operation": "MULTIPLY",
      "value_per_param": 2.0
    }
  ]
}
```

* 上記例では「魔力」1につき威力+2されます。

### 定義例: 「魔力」を3つ消費して強力な効果

```json
"特記処理": {
  "cost": [
    {
      "type": "魔力",
      "value": 3
    }
  ],
  "effects": [...]
}
```
