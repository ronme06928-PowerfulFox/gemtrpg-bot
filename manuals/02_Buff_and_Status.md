# バフ・ステータス (Buff & Status) 総合マニュアル

本システムにおけるバフ・デバフ、および状態異常は、**スプレッドシート定義**、**動的定義(Naming Patterns)**、**静的定義(Code)** の3つのレイヤーで管理されています。

---

## 1. データの優先順位

バフ名が参照された際、システムは以下の順序で定義を検索します。

1. **静的定義 (Static)**:
   - Pythonコード(`manager/buff_catalog.py`)に直接記述された複雑なバフ。
   - 例: `背水の陣` など。
   - 最も優先度が高い。

2. **スプレッドシート定義 (Spreadsheet)**:
   - Google Spreadsheet で管理されているバフ図鑑。
   - 一般的なバフの追加・編集はここで行います。
   - キャッシュファイル: `buff_catalog_cache.json`

3. **動的定義 (Dynamic Patterns)**:
   - バフ名が特定のパターン（例: `AttackUp_Atk10`）に一致する場合、自動的に効果を生成します。
   - 定義ファイルが存在しなくても機能します。

---

## 2. スプレッドシート定義 (Spreadsheet)

基本となるバフ定義方法です。

### 必須カラム構成

| カラム名 | 説明 | 備考 |
| :--- | :--- | :--- |
| **バフID** | システム管理用ID | 例: `Bu-001` |
| **バフ名称** | ゲーム内での表示名 | 一意である必要があります |
| **JSON定義** | 効果内容を記述するJSON | 後述の構成またはPlugin定義を記述 |
| **持続ラウンド** | バフの持続時間 | デフォルト: `1` |
| **バフ説明** | マウスオーバー時の説明文 | |
| **フレーバーテキスト** | 演出用テキスト | **※動的バフでは設定不可** |

### JSON定義の書き方

`JSON定義` カラムには、以下の形式でJSONオブジェクトを記述します。

#### A. ステータス補正型 (Simple Stat Mod)

最も基本的な形式です。

```json
{
  "type": "stat_mod",
  "stat": "基礎威力",
  "value": 5
}
```

- `type`: `"stat_mod"` (固定)
- `stat`: 対象パラメータ (`基礎威力`, `物理補正`, `魔法補正`, `ダイス威力`)
- `value`: 変動値 (マイナスでデバフ)

#### B. プラグイン型 (Plugin Effect)

特殊な挙動をするバフです。実装済みのプラグイン名を指定します。

```json
{
  "type": "plugin",
  "name": "provoke",
  "category": "debuff"
}
```

**利用可能な主要プラグイン一覧** (`plugins/buffs/`):

| プラグイン名 (`name`) | 効果概要 | パラメータ |
| :--- | :--- | :--- |
| `provoke` | **挑発**: 敵のターゲットを自身に固定 | なし |
| `confusion` | **混乱**: 被ダメージ倍加 + 行動阻害 | `damage_multiplier` (float), `restore_mp_on_end` (bool) |
| `immobilize` | **行動不能**: アクション不可 | なし |
| `dodge_lock` | **再回避ロック**: 回避のみ可能、攻撃不可 | なし |
| `timebomb_burst`| **時限破裂**: 終了時に破裂を付与 | なし |
| `burst_no_consume`| **破裂消費無効**: 破裂消費なしで発動可 | なし |

#### C. イベントフック型 (Event Hooks)

特定のゲームイベント発生時に発動する特殊効果です。これらは `effects` 配列ではなく、ルートレベルのプロパティとして定義します。

```json
{
  "on_death": [
    { "type": "APPLY_STATE", "target": "ALL_ENEMIES", "state_name": "呪い", "value": 1 }
  ],
  "battle_start_effect": [
    { "type": "APPLY_STATE", "target": "self", "state_name": "FP", "value": 1 }
  ]
}
```

- **`on_death`**: HPが0以下になった瞬間に発動します。
- **`battle_start_effect`**: 戦闘開始時（リセット時）およびキャラクター配置時に発動します。

---

## 3. 動的定義 (Dynamic Patterns)

特定の命名規則に従うバフは、定義ファイルを作成しなくても自動的に効果が発動します。
**注意**: これらは動的に生成されるため、**説明文やフレーバーテキストを持ちません**（システム的な補正のみ）。

### 命名規則一覧

`[任意の接頭辞]` + `[キーワード]` + `[数値]` の形式で記述します。
例: `AttackBoost_Atk10` (名称: `AttackBoost_Atk10`, 効果: 攻撃威力+10)

| キーワード | 効果 | 例 | 意味 |
| :--- | :--- | :--- | :--- |
| `_Atk` | 攻撃タグを持つスキルの威力UP | `Power_Atk10` | 攻撃威力+10 |
| `_AtkDown` | 攻撃タグを持つスキルの威力DOWN | `Weak_AtkDown5` | 攻撃威力-5 |
| `_Def` | 守備タグを持つスキルの威力UP | `Shield_Def10` | 守備威力+10 |
| `_DefDown` | 守備タグを持つスキルの威力DOWN | `Break_DefDown5` | 守備威力-5 |
| `_Phys` | 物理補正UP (ダイスロール修正) | `Str_Phys2` | 物理補正+2 |
| `_PhysDown`| 物理補正DOWN | `Weak_PhysDown2` | 物理補正-2 |
| `_Mag` | 魔法補正UP | `Int_Mag2` | 魔法補正+2 |
| `_MagDown` | 魔法補正DOWN | `Dull_MagDown2` | 魔法補正-2 |
| `_DaIn` | 被ダメージ倍率増加 (%) | `Paper_DaIn20` | 被ダメ1.2倍 (20%増) |
| `_DaCut` | 被ダメージカット率 (%) | `Hard_DaCut20` | 被ダメ0.8倍 (20%減) |
| `_Crack` | 亀裂付与量UP (**消費しない**) | `Earth_Crack2` | 亀裂付与+2 |
| `_CrackOnce`| 亀裂付与量UP (**1回消費**) | `Quake_CrackOnce3`| 次の亀裂付与+3 (使用後消滅) |
| `_BleedReact`| 被弾時、自身に出血付与 | `Blood_BleedReact2`| 被弾するたび出血+2 |

---

---

## 4. バフプラグイン詳細 (Buff Plugin Details)

特定の `buff_id` を指定することで発動する、スクリプト制御された高度な特殊効果の詳細です。

### 4-1. 破裂威力減少無効 (Burst Conservation)

- **ID**: `Bu-06`

- **効果**: このバフを持つキャラクターが【破裂爆発】を受ける際、本来消費される【破裂】の値が減少しなくなります。
- **用途**: 「次の一撃だけ破裂を消費したくない（破裂2倍ダメージ用）」などのコンボに使用します。

### 4-2. 時限式破裂爆発 (Timed Burst)

- **ID**: `Bu-07`

- **効果**: バフの `delay` カウントが0になった瞬間、自分自身に対して【破裂爆発】が発動します。
- **動作**: 蓄積されている【破裂】値を参照してダメージを与えます。
- **設定**: `APPLY_BUFF` で `delay` (発動までのラウンド) と `lasting: 0` (発動後即消滅) を設定して使用します。

### 4-3. 亀裂崩壊連鎖 (Dual Collapse / Burst Chain)

- **概要**: 「亀裂崩壊」発生時に、さらに別の効果（破裂爆発など）を誘発させることができます。

- **実装方法**: `fissure.py` プラグインの設定により、亀裂消費時に `triggered_effect` を指定して連鎖させることが可能です。（※要上級者向け設定）

### 4-4. 出血維持 (Bleed Maintenance)

- **ID**: `Bu-08`

- **効果**: このバフを持つキャラクターは、ラウンド終了時に【出血】の値が半減しません（現在の値を維持します）。
- **用途**: 出血特化のビルドや、長期的なDoT（継続ダメージ）戦略に使用します。

---

## 5. 特殊なバフ定義 (Advanced)

### 条件付きバフ

`stat_mod` よりも複雑な条件（HP10以下のときのみ等）を設定したい場合、JSON内の `effect` を拡張できますが、現在はスプレッドシート上のJSON定義よりも、`manager/buff_catalog.py` の `STATIC_BUFFS` に直接Pythonコードとして記述することが推奨されます。

```python
# manager/buff_catalog.py の例
"背水の陣": {
    "power_bonus": [{
        "condition": { "source": "self", "param": "HP", "operator": "LTE", "value": 10 },
        "operation": "FIXED",
        "value": 5
    }]
}
```

### フレーバーテキストと表示名のカスタマイズ

 スキル等の `APPLY_BUFF` アクションにおいて、定義元のバフ設定を上書きすることができます。

#### A. フレーバーテキストの追加・上書き

 `flavor` キーを指定することで、動的バフや既存バフに演出テキストを追加できます。

 ```json
 {
   "type": "APPLY_BUFF",
   "buff_name": "Power_Atk5",
   "flavor": "全身に力がみなぎる！"
 }
 ```

#### B. 表示名とロジックの分離 (Name Overriding)

 `buff_id` と `buff_name` を同時に指定することで、**「効果は特定のIDのものを使いつつ、表示名だけ変える」** ことが可能です。

 ```json
 {
   "type": "APPLY_BUFF",
   "buff_id": "Bu-07",
   "buff_name": "時限式魔力爆弾",
   "delay": 3,
   "lasting": 0
 }
 ```

 この例では、システム上は `Bu-07` (時限破裂爆発) として処理されますが、ログや画面には「時限式魔力爆弾」と表示されます。

### 時限発動バフの設定 (Timebomb Configuration)

 「3ラウンド後に爆発する」といった時限式のバフ（例: `Bu-07` 時限破裂爆発）を設定する場合、`delay` と `lasting` の使い分けが重要です。

- **`delay`**: 発動までの待機ラウンド数。この値が 0 になった瞬間に効果（ダメージ等）が発動します。
- **`lasting`**: バフアイコンの表示期間。

 **推奨設定:**
 爆発と同時にバフを消滅させたい場合は、**`lasting: 0`** に設定してください。

 ```json
 // 3ラウンド後に爆発し、直後に消滅する設定
 {
   "type": "APPLY_BUFF",
   "buff_id": "Bu-07",
   "delay": 3,      // カウントダウン
   "lasting": 0     // 完了後即消滅
 }
 ```

---

## 運用のアドバイス

- **基本**: スプレッドシートで管理し、`stat_mod` で数値を定義するのが最も管理しやすい方法です。
- **一時的・システム的バフ**: スキル効果などで「攻撃力を一時的に上げたい」場合などは、いちいちスプレッドシートに登録せず `_Atk10` などの動的パターンを利用するのが効率的です。
