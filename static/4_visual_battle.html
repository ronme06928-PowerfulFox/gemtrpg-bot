<div id="visual-battle-container">
    <div id="map-viewport">
        <div id="game-map">
            <div id="map-grid-layer"></div>
            <div id="map-token-layer"></div>
        </div>

        <div id="map-controls">
            <div class="map-control-group">
                <button id="zoom-in-btn" class="map-btn" title="拡大">＋</button>
                <button id="zoom-out-btn" class="map-btn" title="縮小">－</button>
                <button id="reset-view-btn" class="map-btn" title="リセット">⟲</button>
            </div>
        </div>
    </div>

    <div id="visual-sidebar">

        <div id="visual-timeline-area" style="flex: 0 0 auto; max-height: 25%; border-bottom: 1px solid #ccc; display: flex; flex-direction: column;">
            <div class="sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>TimeLine</span>
                <span style="font-size: 0.9em; font-weight: normal;">Round: <span id="visual-round-counter" style="font-weight: bold;">0</span></span>
            </div>
            <div id="visual-timeline-list" style="overflow-y: auto; flex: 1;">
                </div>
        </div>

        <div id="visual-staging-area" style="flex: 0 0 auto; max-height: 15%; border-bottom: 1px solid #ccc; display: flex; flex-direction: column;">
            <h4 class="sidebar-header">Staging (未配置)</h4>
            <div id="staging-list" style="overflow-y: auto; flex: 1;">
                </div>
        </div>

        <div id="visual-controls-area" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button id="visual-round-start-btn" class="sidebar-btn" style="display:none; flex: 1; background: #17a2b8; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer;">R開始</button>
                <button id="visual-round-end-btn" class="sidebar-btn" style="display:none; flex: 1; background: #f0e0e0; color: #c82333; border: 1px solid #e0c0c0; padding: 5px; border-radius: 4px; cursor: pointer;">R終了</button>
            </div>
            <button id="visual-next-turn-btn" style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">
                ターン終了 (Next Turn)
            </button>
        </div>

        <div id="visual-chat-area" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
            <div class="log-header" style="padding: 5px; background: #eee; border-bottom: 1px solid #ddd; display: flex; gap: 5px;">
                <button class="filter-btn active" data-target="visual-log" data-filter="all" style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer;">All</button>
                <button class="filter-btn" data-target="visual-log" data-filter="chat" style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer;">Chat</button>
                <button class="filter-btn" data-target="visual-log" data-filter="system" style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer;">Sys</button>
            </div>

            <div id="visual-log-area" class="battle-log" style="flex: 1; overflow-y: auto; padding: 5px; font-size: 0.85em; background: #fff;">
                </div>

            <div style="display: flex; border-top: 1px solid #ccc;">
                <input type="text" id="visual-chat-input" placeholder="チャット /roll..." style="flex: 1; border: none; padding: 8px;">
                <button id="visual-chat-send" style="border: none; background: #007bff; color: white; padding: 0 15px; cursor: pointer; font-weight: bold;">Send</button>
            </div>
        </div>

        <div id="visual-room-actions" style="padding: 8px; background: #e9ecef; border-top: 1px solid #ccc; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
            <button id="visual-save-btn" style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 1px solid #ccc; border-radius: 3px; background: #fff;">保存</button>
            <button id="visual-preset-btn" style="padding: 5px; font-size: 0.8em; cursor: pointer; background: #17a2b8; color: white; border: none; border-radius: 3px;">プリセット</button>
            <button id="visual-reset-btn" style="padding: 5px; font-size: 0.8em; cursor: pointer; background: #dc3545; color: white; border: none; border-radius: 3px;">リセット</button>
        </div>
        <div id="visual-status-msg" style="font-size: 0.8em; text-align: center; padding-bottom: 2px; background: #e9ecef; color: #555;"></div>
    </div>
</div>

<div id="duel-modal-backdrop" class="modal-backdrop" style="display: none;">
    <div class="duel-modal-content">
        <h3 class="duel-title">Duel Phase</h3>

        <div class="duel-container">
            <div class="duel-side attacker" id="duel-side-attacker">
                <h4 class="side-title">Attacker (攻)</h4>
                <div class="duel-char-name" id="duel-attacker-name">Character A</div>

                <div class="duel-form-group">
                    <label>Skill:</label>
                    <select id="duel-attacker-skill" class="duel-select"></select>
                </div>

                <div class="duel-control-btns">
                    <button id="duel-attacker-calc-btn" class="duel-btn calc">Calculate</button>
                    <button id="duel-attacker-declare-btn" class="duel-btn declare" disabled>Declare</button>
                </div>

                <div class="duel-preview-area" id="duel-attacker-preview">
                    <div class="preview-command">---</div>
                    <div class="preview-damage">---</div>
                </div>
            </div>

            <div class="duel-center-info">
                <div class="duel-vs">VS</div>
                <div id="duel-status-message" class="duel-status">Setup Phase</div>
            </div>

            <div class="duel-side defender" id="duel-side-defender">
                <h4 class="side-title">Defender (防)</h4>
                <div class="duel-char-name" id="duel-defender-name">Character B</div>

                <div id="duel-defender-controls">
                    <div class="duel-form-group">
                        <label>Skill:</label>
                        <select id="duel-defender-skill" class="duel-select"></select>
                    </div>

                    <div class="duel-control-btns">
                        <button id="duel-defender-calc-btn" class="duel-btn calc">Calculate</button>
                        <button id="duel-defender-declare-btn" class="duel-btn declare" disabled>Declare</button>
                    </div>
                </div>

                <div id="duel-defender-lock-msg" style="display: none; color: #ff6b6b; font-weight: bold; margin: 20px 0;">
                    ⚠ 行動済みのため防御不可<br>(一方攻撃)
                </div>

                <div class="duel-preview-area" id="duel-defender-preview">
                    <div class="preview-command">---</div>
                    <div class="preview-damage">---</div>
                </div>
            </div>
        </div>

        <div class="duel-actions">
            <button id="duel-cancel-btn" class="duel-btn secondary">Cancel</button>
        </div>
    </div>
</div>