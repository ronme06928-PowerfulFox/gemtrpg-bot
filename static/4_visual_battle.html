<div id="visual-battle-container">

    <!-- Â∑¶„Éâ„ÉÉ„ÇØ („Ç¢„ÇØ„Ç∑„Éß„É≥„Éë„Éç„É´) -->
    <div id="action-dock" class="action-dock">
        <div id="dock-match-icon" class="dock-icon" style="display: none;" title="„Éû„ÉÉ„ÉÅÂÆüË°å">‚öîÔ∏è</div>
        <!-- Âç≥ÊôÇÁô∫Âãï„Ç¢„Ç§„Ç≥„É≥ -->
        <div id="dock-immediate-icon" class="dock-icon disabled" title="Âç≥ÊôÇÁô∫Âãï„Çπ„Ç≠„É´">‚ö°</div>
        <!-- „Ç¢„Ç§„ÉÜ„É†„Ç¢„Ç§„Ç≥„É≥ (Phase 5) -->
        <div id="dock-item-icon" class="dock-icon" title="„Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®">üéí</div>
        <!-- „Ç≠„É£„É©ËøΩÂä†„Ç¢„Ç§„Ç≥„É≥ -->
        <div id="dock-add-char-icon" class="dock-icon" title="„Ç≠„É£„É©„ÇØ„Çø„ÉºËøΩÂä†">‚ûï</div>
        <!-- Êú™ÈÖçÁΩÆ„Ç®„É™„Ç¢„Ç¢„Ç§„Ç≥„É≥ -->
        <div id="dock-staging-icon" class="dock-icon" title="Êú™ÈÖçÁΩÆ„Ç≠„É£„É©„ÇØ„Çø„Éº">üì¶</div>
    </div>

    <div id="map-viewport" class="viewport-container" style="display: block;">
        <!-- ‚òÖ „Çø„Ç§„É†„É©„Ç§„É≥ÔºàÂè≥‰∏ä„Å´ÈÖçÁΩÆÔºâ ‚òÖ -->
        <div id="visual-timeline-area">
            <div class="sidebar-header">
                <span>TimeLine</span>
                <span style="font-size: 0.9em; font-weight: normal;">Round: <span id="visual-round-counter"
                        style="font-weight: bold;">0</span></span>
                <span class="timeline-toggle-icon">‚ñº</span>
            </div>
            <div id="visual-timeline-list" style="overflow-y: auto; max-height: 350px; padding: 5px;">
            </div>
        </div>

        <div id="game-map">
            <div id="map-grid-layer"></div>
            <div id="map-token-layer"></div>
        </div>

        <div id="map-controls">
            <div class="map-control-group">
                <button id="zoom-in-btn" class="map-btn" title="Êã°Â§ß">Ôºã</button>
                <button id="zoom-out-btn" class="map-btn" title="Á∏ÆÂ∞è">Ôºç</button>
                <button id="reset-view-btn" class="map-btn" title="„É™„Çª„ÉÉ„Éà">‚ü≤</button>
            </div>
        </div>
    </div>

    <!-- ‚òÖ Exploration Viewport ‚òÖ -->
    <div id="exploration-viewport" class="viewport-container"
        style="display: none; flex: 1; position: relative; background: #2c3e50; overflow: hidden; cursor: grab;">
        <div id="exploration-world"
            style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; transform-origin: 0 0; will-change: transform;">
            <div id="exploration-background"
                style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; background-size: cover; background-position: center;">
            </div>
            <div id="exploration-token-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
            </div>
        </div>

        <!-- Exploration Controls similar to map controls -->
        <div id="exploration-controls" style="position: absolute; bottom: 20px; right: 20px; z-index: 100;">
            <div class="map-control-group">
                <button id="exp-zoom-in-btn" class="map-btn" title="Êã°Â§ß">Ôºã</button>
                <button id="exp-zoom-out-btn" class="map-btn" title="Á∏ÆÂ∞è">Ôºç</button>
                <button id="exp-reset-view-btn" class="map-btn" title="„É™„Çª„ÉÉ„Éà">‚ü≤</button>
                <button id="exp-bg-update-btn" class="map-btn" title="ËÉåÊôØÂ§âÊõ¥" style="display:none;">üñºÔ∏è</button>
            </div>
        </div>
    </div>

    <div id="visual-sidebar">



        <div id="visual-controls-area" style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
            <div style="display: flex; gap: 5px;">
                <button id="visual-round-start-btn" class="sidebar-btn"
                    style="display:none; flex: 1; background: #17a2b8; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer;">RÈñãÂßã</button>
                <button id="visual-round-end-btn" class="sidebar-btn"
                    style="display:none; flex: 1; background: #f0e0e0; color: #c82333; border: 1px solid #e0c0c0; padding: 5px; border-radius: 4px; cursor: pointer;">RÁµÇ‰∫Ü</button>
            </div>
        </div>

        <div id="visual-room-actions"
            style="padding: 8px; background: #e9ecef; border-bottom: 1px solid #ccc; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button id="visual-save-btn"
                style="padding: 5px; font-size: 0.8em; cursor: pointer; border: 1px solid #ccc; border-radius: 3px; background: #fff;">‰øùÂ≠ò</button>
            <button id="visual-preset-btn"
                style="padding: 5px; font-size: 0.8em; cursor: pointer; background: #17a2b8; color: white; border: none; border-radius: 3px;">„Éó„É™„Çª„ÉÉ„Éà</button>
            <button id="visual-reset-btn"
                style="padding: 5px; font-size: 0.8em; cursor: pointer; background: #dc3545; color: white; border: none; border-radius: 3px;">„É™„Çª„ÉÉ„Éà</button>

        </div>

        <div id="visual-chat-area" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
            <div class="log-header"
                style="padding: 5px; background: #eee; border-bottom: 1px solid #ddd; display: flex; gap: 5px;">
                <button class="filter-btn active" data-target="visual-log" data-filter="all"
                    style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer;">All</button>
                <button class="filter-btn" data-target="visual-log" data-filter="chat"
                    style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer;">Chat</button>
                <button class="filter-btn" data-target="visual-log" data-filter="system"
                    style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer;">Sys</button>
                <button id="visual-show-history-btn" class="filter-btn"
                    style="font-size: 0.8em; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; background-color: #6c757d; color: white;">History</button>
            </div>

            <div id="visual-log-area" class="battle-log"
                style="flex: 1; overflow-y: auto; padding: 5px; font-size: 0.85em; background: #fff;">
            </div>

            <div style="display: flex; border-top: 1px solid #ccc;">
                <input type="text" id="visual-chat-input" placeholder="„ÉÅ„É£„ÉÉ„Éà„Åæ„Åü„ÅØ /roll „Ç≥„Éû„É≥„Éâ"
                    style="flex: 1; border: none; padding: 8px;">
                <button id="visual-chat-send"
                    style="border: none; background: #007bff; color: white; padding: 0 15px; cursor: pointer; font-weight: bold;">Send</button>
            </div>
        </div>

        <div id="visual-status-msg"
            style="font-size: 0.8em; text-align: center; padding-bottom: 2px; background: #e9ecef; color: #555;"></div>
    </div>
</div>

<!-- ‚òÖ Match Panel (Fixed on Right Side) ‚òÖ -->
<div id="match-panel" class="match-panel collapsed">
    <div class="panel-header">
        <h3>Duel Phase</h3>
        <div class="panel-header-buttons">
            <button id="panel-reload-btn" class="panel-reload-btn" title="Áä∂ÊÖã„ÇíÂÜçÂêåÊúü">üîÑ</button>
            <button id="panel-toggle-btn" class="panel-toggle-btn" title="„Éë„Éç„É´„ÇíÈñãÈñâ">‚ñ∂</button>
        </div>
    </div>

    <div class="panel-content">
        <!-- Wide Match Container (hidden by default, shown when match_type === 'wide') -->
        <div id="wide-match-container" class="wide-match-container" style="display: none;">
            <!-- Top bar with status and execute button -->
            <div class="wide-match-header-bar">
                <input type="hidden" id="wide-mode-select" value="individual">
                <div id="wide-status" class="wide-status">
                    <span class="waiting">ÂÆ£Ë®ÄÂæÖ„Å°...</span>
                </div>
                <button id="wide-execute-btn" class="duel-btn execute" disabled>‚ö° ÂÆüË°å</button>
            </div>

            <div class="wide-attacker-section">
                <div class="wide-attacker-header-row" style="align-items: flex-start;">
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                        <h4 id="wide-attacker-title" style="margin: 0; margin-bottom: 4px;">‚öîÔ∏è ÊîªÊíÉËÄÖ: <span
                                id="wide-attacker-name" class="clickable-name"></span></h4>
                        <div id="wide-attacker-stats" style="margin-left: 0;"></div>
                    </div>
                    <div id="wide-mode-badge" class="wide-mode-badge">„É¢„Éº„Éâ: <strong id="wide-mode-label">ÂÄãÂà•</strong>
                    </div>
                </div>
                <div class="wide-attacker-controls">
                    <select id="wide-attacker-skill" class="duel-select"></select>
                    <button id="wide-attacker-calc-btn" class="duel-btn calc">Ë®àÁÆó</button>
                    <button id="wide-attacker-declare-btn" class="duel-btn declare" disabled>ÂÆ£Ë®Ä</button>
                </div>
                <div id="wide-attacker-skill-detail" class="wide-skill-detail-area"></div>
                <div id="wide-attacker-result" class="wide-result-display"></div>
                <div id="wide-attacker-declared-badge" class="declared-badge" style="display: none;">‚úì ÂÆ£Ë®ÄÊ∏à</div>
            </div>

            <div class="wide-vs-divider">VS</div>

            <div class="wide-defenders-section">
                <h4>üõ°Ô∏è Èò≤Âæ°ËÄÖ (<span id="wide-defender-count">0</span>‰∫∫)</h4>
                <!-- Allow full height for main panel scrolling -->
                <div id="wide-defenders-list" class="wide-defenders-list" style="max-height: none; overflow: visible;">
                </div>
            </div>
        </div>

        <div class="duel-container">
            <div id="duel-attacker-skill-desc" class="skill-detail-sidebar left"></div>

            <!-- Attacker Section -->
            <div class="duel-card-wrapper">
                <div class="duel-side attacker" id="duel-side-attacker">
                    <h4 class="side-title">Attacker (Êîª)</h4>
                    <div class="duel-char-name clickable-name" id="duel-attacker-name">Character A</div>
                    <div id="duel-attacker-stats" class="duel-char-stats"></div>
                    <div class="duel-form-group">
                        <label>Skill:</label>
                        <select id="duel-attacker-skill" class="duel-select"></select>
                    </div>
                    <div class="duel-control-btns">
                        <button id="duel-attacker-calc-btn" class="duel-btn calc">Â®ÅÂäõË®àÁÆó</button>
                        <button id="duel-attacker-declare-btn" class="duel-btn declare" disabled>ÂÆ£Ë®Ä</button>
                    </div>
                    <div class="duel-preview-area" id="duel-attacker-preview">
                        <div class="preview-command">---</div>
                        <div class="preview-damage">---</div>
                    </div>
                </div>
                <!-- Status icons below attacker card -->
                <div class="duel-status-icons" id="duel-attacker-status"></div>
            </div>

            <div class="duel-center-info">
                <div class="duel-vs">VS</div>
                <div id="duel-status-message" class="duel-status">Setup Phase</div>
            </div>

            <!-- Defender Section -->
            <div class="duel-card-wrapper">
                <div class="duel-side defender" id="duel-side-defender">
                    <h4 class="side-title">Defender (Èò≤)</h4>
                    <div class="duel-char-name clickable-name" id="duel-defender-name">Character B</div>
                    <div id="duel-defender-stats" class="duel-char-stats"></div>
                    <div id="duel-defender-controls">
                        <div class="duel-form-group">
                            <label>Skill:</label>
                            <select id="duel-defender-skill" class="duel-select"></select>
                        </div>
                        <div class="duel-control-btns">
                            <button id="duel-defender-calc-btn" class="duel-btn calc">Â®ÅÂäõË®àÁÆó</button>
                            <button id="duel-defender-declare-btn" class="duel-btn declare" disabled>ÂÆ£Ë®Ä</button>
                        </div>
                    </div>
                    <div id="duel-defender-lock-msg"
                        style="display: none; color: #ff6b6b; font-weight: bold; margin: 20px 0;">
                        ‚ö† Ë°åÂãïÊ∏à„Åø„ÅÆ„Åü„ÇÅÈò≤Âæ°‰∏çÂèØ<br>(‰∏ÄÊñπÊîªÊíÉ)
                    </div>
                    <div class="duel-preview-area" id="duel-defender-preview">
                        <div class="preview-command">---</div>
                        <div class="preview-damage">---</div>
                    </div>
                </div>
                <!-- Status icons below defender card -->
                <div class="duel-status-icons" id="duel-defender-status"></div>
            </div>

            <div id="duel-defender-skill-desc" class="skill-detail-sidebar right"></div>
        </div>
    </div>
</div>

<!-- ‚òÖ Visual Battle Scripts - Separated for maintainability ‚òÖ -->
<script src="js/tab_visual_battle.js?v=20260110_auto_sync"></script>
<script src="js/wide_match_synced.js?v=20260111_1906"></script>
<script src="js/exploration/exploration_view.js?v=20260131_001"></script>
<script src="js/exploration/exploration_dock.js?v=20260131_001"></script>


<!-- ‚òÖ „Ç¢„ÇØ„Ç∑„Éß„É≥„Éâ„ÉÉ„ÇØÁî®„ÅÆCSSË™≠„ÅøËæº„ÅøÔºàJS„ÅØmain.js„ÅßË™≠„ÅøËæº„ÅøÊ∏à„Åø„ÄÇCSS„ÅØstyles.cssÁµ±ÂêàÊ∏à„ÅøÔºâ ‚òÖ -->
<!-- <link rel="stylesheet" href="css/visual_battle_layout.css"> -->
<!-- <link rel="stylesheet" href="css/action_dock.css"> -->